<!DOCTYPE html>
<html lang="fr">
	<head>
		<title>Autonomous Car</title>
		<!-- Leaflet -->
		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
		<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>

		<!-- Roscore -->
		<script type="text/javascript" src="http://cdn.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
		<script type="text/javascript" src="http://cdn.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
		<!-- Scripts -->
		<script src="scripts.js"></script>

	</head>

	<style>
				body {
						padding: 0;
						margin: 0;
				}
				html, body, #map {
						height: 100%;
						width: 100%;
				}
	</style>

	<body>
		<div id="map"></div>
	</body>

	<script>

	// Connecting to ROS
	// -----------------

	var ros = new ROSLIB.Ros({
		url : 'ws://localhost:9090'
	});

	ros.on('connection', function() {
		console.log('Connected to websocket server.');
	});

	ros.on('error', function(error) {
		console.log('Error connecting to websocket server: ', error);
	});

	ros.on('close', function() {
		console.log('Connection to websocket server closed.');
	});

	//===> Global variables
	var map;
	var startPoint;
	var endPoint;
	var markerPosition = L.marker([39,0]);
	var markerFinish = L.marker([0,0]);
	ros.getParams(function(params) {
		console.log(params);
	});
	var currentPosition;
	var routeControl;
	var loadedMap = false;

	var endPositionParam = new ROSLIB.Param({
		ros : ros,
		name : '/routing_machine/destination/'
	});
	endPositionParam.set('{latitude:0, longitude: 0, toGo: false}');

	
 	// Subscribing to a Topic
	// ----------------------

	var listener = new ROSLIB.Topic({
		ros : ros,
		name : '/gps',
		messageType : 'sensor_msgs/NavSatFix'
	});

	listener.subscribe(function(message) {
		if(loadedMap == false) 
		{
			mapInit(message.latitude, message.longitude);
			markerPosition.addTo(map);
			map.on('click', function(e) {
				var lat = e.latlng.lat;
				var lon = e.latlng.lng;
				console.log('Destination set to : '+lat + ' ' + lon);
				endPositionParam.set('{latitude:'+lat+', longitude: '+lon+', toGo: true}');
			});
			loadedMap = true;
		}
		
		markerPosition.setLatLng([message.latitude, message.longitude]);
	 });

	</script>

</html>

