<!DOCTYPE html>
<html lang="fr">
	<head>
		<title>Robotnik panel</title>
		<meta charset="UTF-8">
		<!-- Leaflet -->
		<link rel="stylesheet" href="lib/leaflet/leaflet.css" />
		<script src="lib/leaflet/leaflet.js"></script>

		<!-- Roscore -->
		<script type="text/javascript" src="lib/roslib/eventemitter2.min.js"></script>
		<script type="text/javascript" src="lib/roslib/roslib.min.js"></script>
		<!-- Scripts -->
		<script src="scripts.js"></script>

	</head>

	<style>
				body {
						padding: 0;
						margin: 0;
				}
				html, body, #map {
						height: 100%;
						width: 100%;
				}
	</style>

	<body>
		<div id="map"></div>
	</body>

	<script>
	//===> Global variables
	var map;
	var bounds;
	var currentPosition = {latitude : 0, longitude : 0};
	var startPoint;
	var endPoint;
	var markerPosition = L.marker([39,0]);
	var markerFinish = L.marker([0,0]);
	var zoomLevel = 16;
	var routeControl;
	var loadedMap = false;

	// Connecting to ROS
	// -----------------

	var ros = new ROSLIB.Ros({
		url : 'ws://localhost:9090'
	});

	ros.on('connection', function() {
		console.log('Connected to websocket server.');
	});

	ros.on('error', function(error) {
		console.log('Error connecting to websocket server: ', error);
	});

	ros.on('close', function() {
		console.log('Connection to websocket server closed.');
	});



	var paramStartLat = new ROSLIB.Param({
		ros : ros,
		name : '/routing_machine/start/latitude'
	});
	var paramStartLon = new ROSLIB.Param({
		ros : ros,
		name : '/routing_machine/start/longitude'
	});
	var paramEndLat = new ROSLIB.Param({
		ros : ros,
		name : '/routing_machine/destination/latitude'
	});
	var paramEndLon = new ROSLIB.Param({
		ros : ros,
		name : '/routing_machine/destination/longitude'
	});
	var paramEndGoTo = new ROSLIB.Param({
		ros : ros,
		name : '/routing_machine/destination/goTo'
	});

	paramStartLat.set(0);
	paramStartLon.set(0);	
	paramEndLat.set(0);
	paramEndLon.set(0);
	paramEndGoTo.set(false);

	mapInit();
	map.on('click', function(e) {
		var lat = e.latlng.lat;
		var lon = e.latlng.lng;
		console.log('Routing Start !');
		console.log('Start set to : '+ currentPosition.latitude + ' ' + currentPosition.longitude);
		console.log('Destination set to : '+lat + ' ' + lon);

		paramStartLat.set(currentPosition.latitude);
		paramStartLon.set(currentPosition.longitude);
		paramEndLat.set(lat);
		paramEndLon.set(lon);
		paramEndGoTo.set(true);
	});
	
 	// Subscribing to a Topic
	// ----------------------

	var listenerGPS = new ROSLIB.Topic({
		ros : ros,
		name : '/gps',
		messageType : 'sensor_msgs/NavSatFix'
	});

	var i = 0;

	listenerGPS.subscribe(function(message) {
				
		if(loadedMap == false) 
		{
			map.setView([message.latitude, message.longitude], zoomLevel);
			markerPosition.addTo(map);
			loadedMap = true;
		}
		currentPosition.latitude = message.latitude;
		currentPosition.longitude = message.longitude;

		if(i%20 == 0) // No need to move the marker everytime
		{
			console.log(i);
			markerPosition.setLatLng([message.latitude, message.longitude]);
			bounds = map.getBounds();

			if(!bounds.contains([message.latitude, message.longitude]))
				map.setView([message.latitude, message.longitude], zoomLevel);

		}
		i++;
	 });

	</script>

</html>

